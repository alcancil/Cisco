# Python - 14

## Parsing Autom√°tico - Genie

## Sum√°rio
- [Python - 14](#python---14)
  - [Parsing Autom√°tico - Genie](#parsing-autom√°tico---genie)
  - [Sum√°rio](#sum√°rio)
    - [Introdu√ß√£o ao Genie](#introdu√ß√£o-ao-genie)
    - [Compara√ß√£o: Parsing Manual vs Genie](#compara√ß√£o-parsing-manual-vs-genie)
    - [Documenta√ß√£o oficial](#documenta√ß√£o-oficial)
    - [O que √© um Framework?](#o-que-√©-um-framework)
    - [O que vamos estudar](#o-que-vamos-estudar)
    - [Para que serve o Genie?](#para-que-serve-o-genie)
    - [Quando usar o Genie para Parsing?](#quando-usar-o-genie-para-parsing)
    - [Quando evitar ou adiar o uso do Genie?](#quando-evitar-ou-adiar-o-uso-do-genie)
    - [Fluxo de Decis√£o para Uso do Genie](#fluxo-de-decis√£o-para-uso-do-genie)
  - [Considera√ß√µes sobre IOS vs IOS-XE](#considera√ß√µes-sobre-ios-vs-ios-xe)
    - [Compatibilidade do Genie](#compatibilidade-do-genie)
    - [Recomenda√ß√µes para CCNP:](#recomenda√ß√µes-para-ccnp)
    - [üí° **Por que isso √© importante?**](#-por-que-isso-√©-importante)
  - [Instala√ß√£o e Primeiros Passos com Genie](#instala√ß√£o-e-primeiros-passos-com-genie)
    - [Pr√©-requisitos](#pr√©-requisitos)
    - [Instala√ß√£o](#instala√ß√£o)
    - [Verifica√ß√£o](#verifica√ß√£o)
    - [Estrutura de Parsers](#estrutura-de-parsers)
  - [Onde o Genie se Encaixa? (Fluxo de Processamento)](#onde-o-genie-se-encaixa-fluxo-de-processamento)
    - [Abordagens Comparadas](#abordagens-comparadas)
    - [Casos de Uso T√≠picos do Genie](#casos-de-uso-t√≠picos-do-genie)
    - [Quando N√ÉO Usar Genie?](#quando-n√£o-usar-genie)
    - [Recomenda√ß√µes de Uso](#recomenda√ß√µes-de-uso)
    - [Casos de Uso do Genie (do B√°sico ao Avan√ßado)](#casos-de-uso-do-genie-do-b√°sico-ao-avan√ßado)
    - [Exemplos](#exemplos)
  - [Exemplo 01: Parsing de show ip interface brief com Genie](#exemplo-01-parsing-de-show-ip-interface-brief-com-genie)


### Introdu√ß√£o ao Genie

O Cisco Genie √© um framework de automa√ß√£o e parsing desenvolvido pela Cisco como parte do pyATS/Test Automation Solution. Ele fornece parsers pr√©-constru√≠dos para a maioria dos comandos show da Cisco, transformando sa√≠das de texto n√£o estruturadas em dados estruturados prontos para automa√ß√£o.

**Por que usar Genie para o CCNP ENCOR?**
- Cobre todos os comandos relevantes do blueprint (BGP, OSPF, interfaces, etc.)
- Modelos de dados consistentes para diferentes plataformas IOS-XE, NX-OS, IOS-XR
- Integra√ß√£o com pyATS para testes automatizados
- Economiza tempo em troubleshooting e valida√ß√£o de configura√ß√µes

### Compara√ß√£o: Parsing Manual vs Genie

| Caracter√≠stica          | Parsing Manual | Genie       |
|-------------------------|----------------|-------------|
| Tempo de desenvolvimento | Alto          | Baixo       |
| Manuten√ß√£o              | Complexa       | Simples     |
| Cobertura de comandos   | Limitada       | Amplo       |
| Consist√™ncia            | Vari√°vel       | Padronizado |
| Curva de aprendizado    | Moderada       | Baixa       |
| Adequa√ß√£o para CCNP     | Fundamental    | Essencial   |

### Documenta√ß√£o oficial

Genie - Cisco  
https://developer.cisco.com/docs/genie-docs/

PyYaml  
https://pyyaml.org/wiki/PyYAMLDocumentation

### O que √© um Framework?

Um framework (estrutura, em portugu√™s) √© uma plataforma abrangente que fornece:

  - Uma estrutura base para desenvolvimento

  - Conjunto de ferramentas integradas

  - Conven√ß√µes e melhores pr√°ticas

  - Funcionalidades pr√©-constru√≠das

**Analogia:** Pense como um kit de constru√ß√£o - voc√™ recebe a estrutura b√°sica e ferramentas especializadas para construir algo espec√≠fico.
A Arquitetura pyATS/Genie

```Bash
pyATS (Framework de Teste e Automa√ß√£o)
‚îú‚îÄ‚îÄ Core (Infraestrutura b√°sica)
‚îú‚îÄ‚îÄ Genie (Biblioteca de Parsing e Automa√ß√£o)
‚îÇ   ‚îú‚îÄ‚îÄ Libs (Bibliotecas espec√≠ficas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Parser (An√°lise de comandos)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SDK (Interface de programa√ß√£o)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... 
‚îú‚îÄ‚îÄ XPRESS (API REST)
‚îî‚îÄ‚îÄ Outros componentes
```

**Use Genie quando precisar:**

  - Fazer parsing de comandos **show**

  - Comparar estados de rede **(snapshots)**

  - Criar triggers para **monitoramento**

  - Implementar automa√ß√£o operacional

---
Arrumar

### O que vamos estudar

  - Parsing de JSON: APIs Cisco (DNA Center, Meraki), extra√ß√£o de dados estruturados.

  - Parsing de XML: Configura√ß√µes NETCONF e arquivos legados.

  - Parsing de YAML: Invent√°rios do Ansible e templates declarativos.

  - Regex para CLI: An√°lise de comandos show e logs (ex: BGP, interfaces).

  - Integra√ß√£o com ferramentas: SIEMs (Graylog/Splunk) e parsers autom√°ticos (Genie).

---
Arrumar

### Para que serve o Genie?

Principais objetivos:

  - Extrair informa√ß√µes estruturadas de comandos Cisco: status de interfaces, vizinhos BGP, rotas OSPF, etc., com parsers pr√©-constru√≠dos.

  - Validar automaticamente sa√≠das de comandos, garantindo consist√™ncia entre plataformas (IOS-XE, NX-OS).

  - Transformar CLI em JSON estruturado, pronto para automa√ß√£o em Python.

  - Gerar relat√≥rios e an√°lises comparativas (ex: snapshots antes/depois de mudan√ßas) para ferramentas como Grafana ou SIEMs.

**Diferencial:** Elimina a necessidade de regex manual, padronizando o parsing em ambientes Cisco.

### Quando usar o Genie para Parsing?

Voc√™ deve considerar o Genie para parsing quando:  

| Cen√°rio	                                        | Exemplo com Genie                          	                  | Benef√≠cio do Genie                                                  |
|-------------------------------------------------|---------------------------------------------------------------|---------------------------------------------------------------------|
|üì§ Trabalha com sa√≠das de comandos Cisco	        | show ip interface brief, show bgp summary	                    | Parsers pr√©-constru√≠dos para +500 comandos Cisco                    |
|üß© Precisa de dados estruturados consistentes    | Comparar snapshots de show interface antes/depois de mudan√ßas | Modelos de dados padronizados para todas plataformas (IOS-XE, NX-OS, IOS-XR) |
|üìä Requer valida√ß√£o complexa de estado de rede   | Verificar se todos vizinhos BGP est√£o estabelecidos           | Fun√ß√µes built-in para an√°lise de estado                             |
|üîÑ Desenvolve automa√ß√£o operacional              | Monitorar flaps de interface automaticamente                  | Sistema de triggers e aprendizado de estado                         |
|üïµÔ∏è Precisa fazer troubleshooting em larga escala | Identificar interfaces down em 100 dispositivos               | Parsing eficiente e relat√≥rios consolidados                        |

### Quando evitar ou adiar o uso do Genie?

O Genie pode n√£o ser a melhor escolha quando:  

| Situa√ß√£o                                                    | Alternativa Recomendada	Raz√£o                                                               |
|-------------------------------------------------------------|---------------------------------------------------------------------------------------------|
| Trabalha com equipamentos n√£o-Cisco                         | Parsers customizados ou bibliotecas vendor-specific	Cobertura limitada a ecossistema Cisco  |
| Necessita parsing de sa√≠das completamente customizadas      | Regex ou parsing manual	Genie funciona melhor com sa√≠das de comandos padr√£o                 |
| Desenvolve solu√ß√µes simples/√∫nicas                          | Processamento b√°sico de strings	Overhead de configura√ß√£o pode n√£o valer a pena              |
| Trabalha com formatos n√£o suportados (ex: logs espec√≠ficos) | Ferramentas especializadas (Logstash, etc.)	Genie foca em sa√≠das de comandos CLI            |
| Precisa de parsing em tempo real extremamente r√°pido        | Processamento direto na CLI	Genie adiciona pequena lat√™ncia na transforma√ß√£o                |

### Fluxo de Decis√£o para Uso do Genie

```mermaid
flowchart TD
    A[Precisa analisar sa√≠da de equipamento?] --> B{√â equipamento Cisco?}
    B -->|Sim| C{Comando √© suportado pelo Genie?}
    B -->|N√£o| D[Considere parsing manual/outras libs]
    C -->|Sim| E[Use Genie - Melhor custo-benef√≠cio]
    C -->|N√£o| F[Combine Genie com parsing customizado]
    
    style E fill:#006400,stroke:#00ff00,color:#ffffff 
    style D fill:#dc3545,stroke:#ff0000,color:#ffffff
    style F fill:#ffc107,stroke:#ffcc00,color:#000000
```

**Legenda:**

    üü¢ Verde: Casos ideais para Genie

    üü° Amarelo: Casos que podem usar Genie parcialmente

    üî¥ Vermelho: Casos onde Genie n√£o √© recomendado

## Considera√ß√µes sobre IOS vs IOS-XE

### Compatibilidade do Genie
| Feature          | IOS Tradicional | IOS-XE |
|------------------|-----------------|--------|
| Parsers CLI      | 85% cobertura   | 100%   |
| Valida√ß√£o        | B√°sica          | Avan√ßada |
| APIs             | N√£o             | Sim    |

### Recomenda√ß√µes para CCNP:
1. Priorize estudos em IOS-XE
2. Para IOS legado:
   - Use `genie.libs.parser.ios`
   - Combine com regex quando necess√°rio
3. Pratique a convers√£o mental entre sintaxes:
   ```bash
   # IOS
   show ip interface brief
   # IOS-XE
   show interface | include IP
   ```

### üí° **Por que isso √© importante?**
- **Mercado**: Novos projetos Cisco s√£o quase todos IOS-XE
- **Exame**: CCNP ENCOR testa ambos, mas com pesos diferentes
- **Automa√ß√£o**: Seu c√≥digo precisar√° lidar com ambientes h√≠bridos

## Instala√ß√£o e Primeiros Passos com Genie

### Pr√©-requisitos
- Python 3.6+
- PIP atualizado
- Ambiente virtual (recomendado)

### Instala√ß√£o
```bash
# Op√ß√£o 1: Apenas Genie (para parsing - vamos utilizar esse agora)
pip install genie

# Op√ß√£o 2: pyATS completo (recomendado para CCNP)
pip install pyats[full]
```

### Verifica√ß√£o

```python
from genie.conf import Genie
genie = Genie.init()
print(f"Genie {genie.version} instalado corretamente")
```

### Estrutura de Parsers

Principais m√≥dulos para CCNP ENCOR:

```Bash
genie/
‚îî‚îÄ‚îÄ libs/
    ‚îî‚îÄ‚îÄ parser/
        ‚îú‚îÄ‚îÄ iosxe/
        ‚îÇ   ‚îú‚îÄ‚îÄ show_interface.py
        ‚îÇ   ‚îú‚îÄ‚îÄ show_bgp.py
        ‚îÇ   ‚îî‚îÄ‚îÄ show_ip_route.py
        ‚îî‚îÄ‚îÄ nxos/  # Para estudos multivendor
```

Exemplo B√°sico - Parsing de Interface

```python
from genie.libs.parser.iosxe.show_interface import ShowIpInterfaceBrief

output = '''
Interface              IP-Address      OK? Method Status                Protocol
GigabitEthernet0/0     192.168.1.1    YES manual up                    up
GigabitEthernet0/1     unassigned     YES unset  administratively down down
'''

parsed = ShowIpInterfaceBrief.parse(output=output)
print(f"Status de G0/0: {parsed['interface']['GigabitEthernet0/0']['status']}")
```

**Sa√≠da Esperada:**

```Bash
Status de G0/0: up
```

## Onde o Genie se Encaixa? (Fluxo de Processamento)

```mermaid
flowchart TD
    A[Dispositivo Cisco] -->|M√©todo 1: Syslog RAW| B[Graylog/Wazuh/Splunk/SIEM]
    A -->|M√©todo 2: Genie como Pr√©-processador| C{{Processamento}}
    C --> D[SIEM/Dashboard]
    C --> E[Automa√ß√£o Python]

    style A fill:#006400,stroke:#00ff00,color:#ffffff 
    style C fill:#dc3545,stroke:#ff0000,color:#ffffff
    style D fill:#ffc107,stroke:#ffcc00,color:#000000
    style E fill:#ffc107,stroke:#ffcc00,color:#000000
```

### Abordagens Comparadas

**Abordagem 1: Syslog Direto (Sem Genie)**

Como funciona:
    
  ```bash
    Router(config)# logging host 10.0.0.100  # Envia logs brutos para Graylog
  ```
    
**Pr√≥s:**

  - Simplicidade de configura√ß√£o

  - Baixa lat√™ncia

**Contras:**

  - Dados n√£o estruturados (ex: %BGP-5-ADJCHANGE: neighbor 10.0.0.1 Down)

  - Necessidade de parsers no SIEM (GroK, regex)

  - Limitado a eventos pr√©-definidos

**Abordagem 2: Genie como Pr√©-processador (Recomendada para CCNP/automa√ß√£o)**

Fluxo:

  - Script Python coleta dados via SSH/API (ex: show bgp summary)

  - Genie faz parsing estruturado:
      
      ```python
        from genie.libs.parser.iosxe.show_bgp import ShowBgpAllSummary
        parsed = ShowBgpAllSummary.parse(device_output)
      ```
        
Dados s√£o:

  - Enviados para SIEM como JSON estruturado

  - Ou processados localmente (ex: alertas via Slack)

**Vantagens:**

  - Estrutura√ß√£o RICA: Transforma "up/down" em {"bgp_neighbors": {"10.0.0.1": {"state": "down", "uptime": "00:01:23"}}}

  - Contexto para Troubleshooting: Mant√©m rela√ß√µes entre dados (ex: interface + BGP + OSPF)

  - Valida√ß√£o Autom√°tica: Checa se dados est√£o completos antes do envio

  - Prepara√ß√£o para CCNP: Pratica comandos show e an√°lise estruturada

### Casos de Uso T√≠picos do Genie

| Cen√°rio         | Exemplo	Vantagem vs. Syslog Bruto                                           |
|-----------------|-----------------------------------------------------------------------------|
| Troubleshooting	| Extrair todos vizinhos BGP inativos	Dados prontos para an√°lise em Grafana   |
| Compliance      | Verificar se todas interfaces t√™m descri√ß√£o	Valida√ß√£o program√°tica          | 
| Monitoramento   | Alertar se >50% da CPU por 5min	Correla√ß√£o com outros dados                 |

### Quando N√ÉO Usar Genie?

- Logs de Eventos Simples (ex: %LINK-UPDOWN): Syslog direto √© suficiente

- Ambientes N√£o-Cisco: Genie tem suporte limitado a outros vendors

- Lat√™ncia Cr√≠tica: Parsing adiciona ~100-500ms de processamento

### Recomenda√ß√µes de Uso

**Compara√ß√£o Detalhada**

| Ferramenta        | Cisco      | Juniper | Arista | Nokia | API First | Learning Mode |
|-------------------|------------|---------|--------|-------|-----------|---------------|
| Genie             | ‚úÖ‚úÖ‚úÖ   | ‚úÖ      | ‚úÖ     | ‚ùå   | ‚úÖ        | ‚úÖ           |
| TextFSM           | ‚úÖ‚úÖ      | ‚úÖ‚úÖ	 | ‚úÖ‚úÖ	 | ‚úÖ    | ‚ùå	      | ‚ùå            |
| PyATS             | ‚úÖ‚úÖ‚úÖ    | ‚úÖ	   | ‚úÖ     | ‚úÖ   | ‚úÖ        | ‚úÖ           |
| Ansible cli_parse | ‚úÖ‚úÖ      | ‚úÖ‚úÖ   | ‚úÖ‚úÖ  | ‚úÖ‚úÖ | ‚úÖ        | ‚ùå           |
| Scrapli	          | ‚úÖ‚úÖ      | ‚úÖ‚úÖ   | ‚úÖ     | ‚ùå   | ‚úÖ        | ‚ùå           |

Legenda: ‚úÖ‚úÖ‚úÖ = Suporte nativo completo | ‚úÖ = Suporte b√°sico

**Quando Usar Cada Uma?**

  - Ambientes Cisco-dominantess ‚Üí Genie/PyATS

  - Multivendor com foco em legacy ‚Üí TextFSM + NTC-Templates

  - Automa√ß√£o com Ansible existente ‚Üí cli_parse

  - Performance cr√≠tica ‚Üí Scrapli

### Casos de Uso do Genie (do B√°sico ao Avan√ßado)

| Comando                 | Protocolo/Feature | Aplica√ß√£o T√≠pica                                                             |
|-------------------------|-------------------|------------------------------------------------------------------------------|
| show ip interface brief | Interfaces        | Verificar status (up/down) e endere√ßos IP das interfaces.                    |
| show version            | Sistema           | Coletar modelo, vers√£o do IOS e tempo de opera√ß√£o (uptime).                  |
| show vlan brief         | VLANs (Switches)  | Listar VLANs configuradas e portas associadas.                               |
| show cdp neighbors      | Topologia         | Mapear dispositivos vizinhos e conex√µes.                                     |
| show ip ospf neighbor   | OSPF              | Verificar adjac√™ncias (FULL/DOWN) e problemas de vizinhan√ßa.                 |
| show ip eigrp neighbors | EIGRP             | Monitorar estabilidade de vizinhos EIGRP.                                    |
| show bgp summary        | BGP               | Checar sess√µes com peers (estabelecidas/pendentes) e contagem de rotas.      |
| show ip route	          | Roteamento	      | Analisar rotas (OSPF, EIGRP, est√°ticas) e m√©tricas.                          |
| show running-config     | Configura√ß√£o      | Auditoria de seguran√ßa (ACLs, SNMP) ou compliance (descri√ß√£o de interfaces). |
| show interface trunk    | VLANs (Trunks)    | Verificar trunks configurados e modo de encapsulamento (802.1Q).             |
| Snapshot (antes/depois) | Todos             | Validar impactos de mudan√ßas (ex.: interfaces que ca√≠ram ap√≥s upgrade).      |
| show tech-support       | Diagn√≥stico	      | Troubleshooting avan√ßado (combina dados de m√∫ltiplos comandos).              |

### Exemplos

## Exemplo 01: Parsing de show ip interface brief com Genie

**Objetivo:** Extrair status e endere√ßos IP de interfaces de forma estruturada.  

**üìÅ Estrutura recomendada**

```Bash
genie/
‚îî‚îÄ‚îÄ 01/
    ‚îú‚îÄ‚îÄ parse_interface_brief.py
    ‚îî‚îÄ‚îÄ mock_data/
        ‚îî‚îÄ‚îÄ show_ip_interface_brief.txt
```

**Requerimentos: requiremnets.txt**

```txt
pyats[full]
```

**show_ip_interface_brief.txt**

```txt
Interface              IP-Address      OK? Method Status                Protocol
GigabitEthernet1       unassigned      YES unset  administratively down down    
GigabitEthernet2       10.1.1.1        YES manual up                    up      
Loopback0              192.168.0.1     YES manual up                    up      
```

**parse_interface_brief.py**

```python
from genie.libs.parser.iosxe.show_interface import ShowIpInterfaceBrief

class DummyDevice:
    def __init__(self, name='mock'):
        self.name = name

device = DummyDevice()

# Leitura do conte√∫do mock
with open('mock_data/show_ip_interface_brief.txt') as f:
    raw_output = f.read()

# Parsing
parser = ShowIpInterfaceBrief(device=device)
parsed = parser.parse(output=raw_output)

print("\n=== Interfaces Ativas ===")
for intf, details in parsed['interface'].items():
    if details.get('status', '').strip() == 'up':
        print(f"{intf}:")
        print(f"  IP: {details.get('ip_address', 'N/A').strip()}")
        print(f"  Status: {details.get('status', 'N/A').strip()}")
        print(f"  Protocolo: {details.get('protocol', 'N/A').strip()}\n")

print("\n=== Interfaces Inativas ===")
for intf, details in parsed['interface'].items():
    if details.get('status', '').strip() != 'up':
        print(f"{intf}: {details.get('status', 'unknown').strip()}")
```

**Sa√≠da**

```Bash
alcancil@linux:~/automacoes/genie/01$ python3 -m venv genie
alcancil@linux:~/automacoes/genie/01$ source genie/bin/activate
genie) alcancil@linux:~/automacoes/genie/01$ pip install -r requiremnets.txt 
Collecting pyats[full] (from -r requiremnets.txt (line 1))
  Using cached pyats-25.5-cp312-cp312-manylinux2014_x86_64.whl.metadata (4.5 kB)
Collecting packaging>=20.0 (from pyats[full]->-r requiremnets.txt (line 1))
  Using cached packaging-25.0-py3-none-any.whl.metadata (3.3 kB)
Collecting pyats.aereport<25.6.0,>=25.5.0 (from pyats[full]->-r requiremnets.txt (line 1))
  Using cached pyats.aereport-25.5-cp312-cp312-manylinux2014_x86_64.whl.metadata (3.2 kB)
...
4.67.1 types-python-dateutil-2.9.0.20250516 typing-extensions-4.14.0 unicon-25.5 unicon.plugins-25.5 urllib3-2.5.0 wcwidth-0.2.13 websocket-client-1.8.0 wheel-0.45.1 wsproto-1.2.0 xlrd-1.2.0 xlsxwriter-3.2.5 xlwt-1.3.0 xmltodict-0.12.0 yamllint-1.37.1 yang.connector-25.5 yarl-1.20.1
(genie) alcancil@linux:~/automacoes/genie/01$ python3 parse_interface_brief.py 
/home/alcancil/automacoes/genie/01/genie/lib/python3.12/site-packages/unicon/__init__.py:10: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
  from unicon.core.pluginmanager import PluginManager

=== Interfaces Ativas ===
GigabitEthernet2:
  IP: 10.1.1.1
  Status: up
  Protocolo: up

Loopback0:
  IP: 192.168.0.1
  Status: up
  Protocolo: up


=== Interfaces Inativas ===
GigabitEthernet1: administratively down
(genie) alcancil@linux:~/automacoes/genie/01$ 
```

---
Continuar




