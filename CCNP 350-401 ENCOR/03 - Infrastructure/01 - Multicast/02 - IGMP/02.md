# √çndice

- [√çndice](#√≠ndice)
  - [IGMPv3](#igmpv3)
    - [Funcionamento do IGMPv3](#funcionamento-do-igmpv3)
    - [Processo de Participa√ß√£o no IGMPv3](#processo-de-participa√ß√£o-no-igmpv3)
    - [Consultas no IGMPv3](#consultas-no-igmpv3)
    - [Elei√ß√£o do Querier no IGMPv3](#elei√ß√£o-do-querier-no-igmpv3)
    - [Fluxograma do Processo IGMPv3](#fluxograma-do-processo-igmpv3)
    - [Tipos de Transi√ß√µes de Estado no IGMPv3](#tipos-de-transi√ß√µes-de-estado-no-igmpv3)
    - [Vantagens do IGMPv3](#vantagens-do-igmpv3)
    - [Resumo da Opera√ß√£o do IGMPv3](#resumo-da-opera√ß√£o-do-igmpv3)

## IGMPv3

O IGMPv3 evolui em rela√ß√£o √† vers√£o 2 ao permitir identificar a origem desejada do tr√°fego multicast, possibilitando que os destinat√°rios apliquem filtros de origem e escolham de quais fontes receber o tr√°fego.  

Essa vers√£o foi desenvolvida para coexistir junto das outras. A diferen√ßa da vers√£o 3 para 2 √© que na vers√£o 3 foram acrescentados novos campos na consulta de ades√£o e um novo tipo de
mensagem IGMP chamado relat√≥rio de associa√ß√£o da vers√£o 3 para oferecer suporte √† filtragem de origem.  

O IGMPv3 oferece suporte a aplicativos que sinalizam fontes explicitamente do qual desejam receber tr√°fego. Com o IGMPv3, os destinat√°rios sinalizam a inten√ß√£o de se associar a um endere√ßo de grupo multicast usando um relat√≥rio de associa√ß√£o nos dois modos a seguir:

- **MODO DE INCLUS√ÇO:** nesse modo, o destinat√°rio anuncia a ades√£o para um endere√ßo de grupo de multicast e fornece uma lista (include list) de endere√ßos de fontes de quem ele deseja receber o tr√°fego
- **MODO DE EXCLUS√ÇO:** nesse modo, o destinat√°rio anuncia a ades√£o para um endere√ßo de grupo de multicast e fornece uma lista (exclude list) de endere√ßos de quem ele n√£o receber o tr√°fego.
Para receber o tr√°fego de todas as fontes, que √© o comportamento do IGMPv2, o destinat√°rio utiliza **o modo de exclus√£o de ades√£o com um uma lista de exclus√£o vazia**

![IGMP](Imagens/igmpv3.png)  

- **C√ìDIGO M√ÅXIMO DE RESPOSTA :** Este campo √© ignorado para tipos de mensagens diferentes de consulta de associa√ß√£o. Para o tipo de consulta de ades√£o, √© o tempo m√°ximo permitido antes de enviar um relat√≥rio de resposta. O valor est√° em unidades de 0,1 segundos.
- **CHECKSUM :** campo de 16 bits 1 que complementa a soma da mensagem IGMP. √â o mesmo algoritmo utilizado pelo TCP/IP.
- **ENDERE√áO DE GRUPO :** √â definido como 0 ao enviar uma consulta geral. Caso contr√°rio, endere√ßo multicast para consultas espec√≠ficas de grupo ou de origem.
- **RESV :** √â configurado em 0 e √© ignorado quando recebido
- **S FLAG :** Representa o sinalizador Suprimir processamento do lado do roteador. Quando o sinalizador est√° definido, ele indica a supress√£o das atualiza√ß√µes de timer que os roteadores multicast realizam ao receber qualquer consulta.
- **QRV :** Representa a vari√°vel de robustez do consultor (querier). Os roteadores continuam recuperando o valor QRV da consulta recebida mais recentemente como seu pr√≥prio valor at√© que o QRV recebido mais recentemente seja zero.
- **QQIC :** Representa o c√≥digo de intervalo de consulta do consultor.
- **N√öMERO DE FONTES :** Representa o n√∫mero de endere√ßos de origem presentes na consulta. Para consulta geral ou consulta espec√≠fica de grupo, este campo √© zero e para consulta espec√≠fica de grupo e origem, este campo √© diferente de zero.
- **ENDERE√áO DE ORIGEM[N] :** Representa o endere√ßo IP unicast para N campos.

### Funcionamento do IGMPv3  

Quando um destinat√°rio deseja ingressar em um grupo multicast no IGMPv3, ele envia uma mensagem IGMPv3 Membership Report que pode conter m√∫ltiplos registros de grupo em uma √∫nica mensagem. Cada registro especifica:  

- O endere√ßo do grupo multicast
- O modo de filtro (Include ou Exclude)
- A lista de endere√ßos de origem

O roteador que atua como querier processa esses relat√≥rios e mant√©m o estado de cada grupo, incluindo as listas de origem associadas. Isso permite um controle muito mais granular sobre qual tr√°fego multicast √© encaminhado.

### Processo de Participa√ß√£o no IGMPv3  

**Modo de Inclus√£o (Include Mode):**  

O host especifica exatamente de quais fontes deseja receber tr√°fego  
Exemplo: "Quero receber o grupo 224.1.1.1, mas apenas das fontes 10.1.1.1 e 10.1.1.2" 

```mermaid
sequenceDiagram
    participant Host
    participant Switch
    participant Roteador
    participant Fonte1 as Fonte A<br>(10.1.1.1)
    participant Fonte2 as Fonte B<br>(10.1.1.2)

    Host->>Roteador: IGMPv3 Report - INCLUDE Mode<br>Grupo: 224.1.1.1<br>Fontes: [10.1.1.1]
    Note right of Roteador: Adiciona grupo com<br>filtro de origem espec√≠fica
    Host->>Switch: IGMPv3 Report (escutado via IGMP Snooping)
    Note right of Switch: Associa porta ao grupo<br>com filtro de origem

    Roteador-->>Host: General Query (peri√≥dico)
    Host->>Roteador: IGMPv3 Report - INCLUDE Mode<br>Fontes: [10.1.1.1]

    Fonte1->>Roteador: Tr√°fego Multicast (224.1.1.1)
    Roteador->>Host: Encaminha tr√°fego ‚úÖ
    
    Fonte2->>Roteador: Tr√°fego Multicast (224.1.1.1)
    Note right of Roteador: Filtrado - fonte n√£o est√°<br>na lista INCLUDE ‚ùå

    Host->>Roteador: IGMPv3 Report - TO_IN(NULL)<br>(equivalente ao Leave)
    Roteador->>Host: Group-and-Source-Specific Query
    Note right of Roteador: Remove grupo da tabela<br>se n√£o houver resposta
````

**Modo de Exclus√£o (Exclude Mode):**

O host especifica de quais fontes N√ÉO deseja receber tr√°fego  
Exemplo: "Quero receber o grupo 224.1.1.1 de todas as fontes, exceto de 10.1.1.3"  

Para manter compatibilidade com IGMPv2: Um host pode usar o modo de exclus√£o com lista vazia, indicando que deseja receber de todas as fontes (comportamento padr√£o do IGMPv2).

```mermaid
sequenceDiagram
    participant Host
    participant Switch
    participant Roteador
    participant Fonte1 as Fonte A<br>(10.1.1.1)
    participant Fonte2 as Fonte B<br>(10.1.1.2)
    participant Fonte3 as Fonte C<br>(10.1.1.3)

    Host->>Roteador: IGMPv3 Report - EXCLUDE Mode<br>Grupo: 224.1.1.1<br>Fontes Bloqueadas: [10.1.1.3]
    Note right of Roteador: Adiciona grupo com<br>lista de exclus√£o
    Host->>Switch: IGMPv3 Report (escutado via IGMP Snooping)
    Note right of Switch: Associa porta ao grupo<br>com filtro de exclus√£o

    Roteador-->>Host: General Query (peri√≥dico)
    Host->>Roteador: IGMPv3 Report - EXCLUDE Mode<br>Fontes Bloqueadas: [10.1.1.3]

    Fonte1->>Roteador: Tr√°fego Multicast (224.1.1.1)
    Roteador->>Host: Encaminha tr√°fego ‚úÖ
    
    Fonte2->>Roteador: Tr√°fego Multicast (224.1.1.1)
    Roteador->>Host: Encaminha tr√°fego ‚úÖ

    Fonte3->>Roteador: Tr√°fego Multicast (224.1.1.1)
    Note right of Roteador: Filtrado - fonte est√° na<br>lista EXCLUDE ‚ùå

    Host->>Roteador: IGMPv3 Report - TO_IN(NULL)<br>(Leave Group)
    Roteador->>Host: Group-Specific Query
    Note right of Roteador: Remove grupo da tabela<br>se n√£o houver resposta
```

### Consultas no IGMPv3  

O IGMPv3 suporta tr√™s tipos de consultas:

- **General Query:** Verifica todos os grupos ativos (endere√ßo de grupo = 0.0.0.0)
- **Group-Specific Query:** Verifica um grupo espec√≠fico
- **Group-and-Source-Specific Query:** Verifica um grupo e fontes espec√≠ficas

### Elei√ß√£o do Querier no IGMPv3

O processo de elei√ß√£o do querier no IGMPv3 mant√©m o mesmo princ√≠pio do IGMPv2: o roteador com menor endere√ßo IP na interface local vence a elei√ß√£o. Por√©m, o IGMPv3 introduz melhorias:  

- **Consultas mais espec√≠ficas:** O querier pode fazer consultas direcionadas para grupos e fontes espec√≠ficas
- **Melhor efici√™ncia:** Reduz o tr√°fego desnecess√°rio ao permitir consultas mais granulares
- **Compatibilidade:** Queriers IGMPv3 podem interagir com hosts IGMPv1/v2 na mesma rede

### Fluxograma do Processo IGMPv3

```mermaid
%%{init: {"themeVariables": {
  "fontSize": "16px",
  "fontWeight": "bold"
}, "flowchart": { "nodeSpacing": 50, "rankSpacing": 70 }}}%%
flowchart TD

    %% --- Defini√ß√£o dos n√≥s ---
    START([**Host deseja ingressar<br>em grupo multicast**]):::start
    
    DECISION{**Qual modo<br>de filtro?**}:::decision
    
    %% Modo Include
    INCLUDE[**MODO INCLUDE** - Especifica fontes permitidas]:::include
    INC_REPORT[**Envia IGMPv3 Report** - INCLUDE Mode - Lista: fontes desejadas]:::include
    INC_FILTER[**Roteador filtra tr√°fego** - ‚úÖ Fontes na lista INCLUDE<br>‚ùå Outras fontes]:::include
    
    %% Modo Exclude  
    EXCLUDE[**MODO EXCLUDE**<br>Especifica fontes bloqueadas]:::exclude
    EXC_REPORT[**Envia IGMPv3 Report** - EXCLUDE Mode<br>Lista: fontes bloqueadas]:::exclude
    EXC_FILTER[**Roteador filtra tr√°fego** - ‚úÖ Todas as fontes<br>‚ùå Fontes na lista EXCLUDE]:::exclude
    
    %% Processo comum
    ROUTER[**Roteador processa** - Adiciona √† tabela multicast com filtros de origem]:::router
    QUERY[**Queries peri√≥dicas** - General, Group-Specific - Group-and-Source-Specific]:::router
    RESPONSE[**Host responde** com IGMPv3 Reports atualizados]:::host
    
    %% Leave process
    LEAVE[**Host deseja sair** TO_IN - NULL Report]:::leave
    QUERY_LEAVE[**Roteador envia** Group/Source-Specific Query]:::router
    REMOVE[**Remove grupo se** n√£o houver resposta]:::router

    %% --- Conex√µes ---
    START --> DECISION
    
    DECISION -->|Include| INCLUDE
    DECISION -->|Exclude| EXCLUDE
    
    INCLUDE --> INC_REPORT --> INC_FILTER
    EXCLUDE --> EXC_REPORT --> EXC_FILTER
    
    INC_FILTER --> ROUTER
    EXC_FILTER --> ROUTER
    
    ROUTER --> QUERY --> RESPONSE --> QUERY
    RESPONSE --> LEAVE --> QUERY_LEAVE --> REMOVE

    %% --- Estilos ---
    classDef start fill:#e1f5fe,stroke:#0277bd,stroke-width:2px,color:#000,font-weight:bold;
    classDef decision fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000,font-weight:bold;
    classDef include fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#000,font-weight:bold;
    classDef exclude fill:#fce4ec,stroke:#c2185b,stroke-width:2px,color:#000,font-weight:bold;
    classDef router fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000,font-weight:bold;
    classDef host fill:#e0f2f1,stroke:#00695c,stroke-width:2px,color:#000,font-weight:bold;
    classDef leave fill:#ffebee,stroke:#d32f2f,stroke-width:2px,color:#000,font-weight:bold;
```

[IGMPv3 - Anima√ß√£o](https://alcancil.github.io/Cisco/CCNP%20350-401%20ENCOR/03%20-%20Infrastructure/01%20-%20Multicast/02%20-%20IGMP/Arquivos/igmpv3.html)

### Tipos de Transi√ß√µes de Estado no IGMPv3  

O IGMPv3 define v√°rias transi√ß√µes de estado que s√£o comunicadas atrav√©s dos reports:

| Transi√ß√£o | Significado                           | Exemplo de Uso                                 |
|-----------|---------------------------------------|------------------------------------------------|
| TO_IN(A)  | Mudan√ßa para modo Include com lista A | Host quer receber apenas de fontes espec√≠ficas |
| TO_EX(A)  | Mudan√ßa para modo Exclude com lista A | Host quer receber de todas, exceto lista A     |
| ALLOW(A)  | Adicionar fontes A √† lista atual      | Host quer receber de fontes adicionais         |
| BLOCK(A)  | Remover fontes A da lista atual       | Host n√£o quer mais receber de certas fontes    |

Essas transi√ß√µes permitem que o host modifique dinamicamente suas prefer√™ncias de recebimento sem precisar sair e reingressar no grupo.

### Vantagens do IGMPv3

- **Source-Specific Multicast (SSM):** Permite especificar exatamente de qual fonte receber
- **Melhor seguran√ßa:** Hosts podem bloquear fontes indesejadas
- **Efici√™ncia aprimorada:** Reduz tr√°fego desnecess√°rio na rede
- **Compatibilidade:** Coexiste com vers√µes anteriores
- **Controle granular:** M√∫ltiplos grupos e fontes em uma √∫nica mensagem

### Resumo da Opera√ß√£o do IGMPv3

**üìπ Pap√©is**  

- **Host (receptor):** informa ao roteador quais grupos deseja participar e de quais fontes espec√≠ficas
- **Querier (roteador):** mant√©m estado detalhado de grupos e suas listas de origem

**üìπ Tipos de Mensagens**  

| Mensagem          | Origem  | Fun√ß√£o                                                             |
|-------------------|---------|--------------------------------------------------------------------|
| IGMPv3 Membership | Report  | HostAnuncia participa√ß√£o em grupos com lista de fontes espec√≠ficas |
| General Query     | Querier | Verifica todos os grupos ativosGroup-Specific                      |
| Query             | Querier | Verifica um grupo espec√≠fico                                       |
| Group-and-Source  | Query   | Querier Verifica um grupo e fontes espec√≠ficas                     |

**Estados de Filtro**  

O IGMPv3 mant√©m estados de filtro para cada interface:

- **INCLUDE (S,G):** Recebe tr√°fego do grupo G apenas das fontes na lista S
- **EXCLUDE (S,G):** Recebe tr√°fego do grupo G de todas as fontes, exceto as da lista S

Esses estados s√£o fundamentais para o funcionamento correto do Source-Specific Multicast (SSM) e permitem que aplica√ß√µes tenham controle preciso sobre suas fontes de dados.
